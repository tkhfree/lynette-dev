# Makefile for GeoNetworking V2X Example
# 用于编译和部署 GeoNetworking 车联网示例

# 配置
LYNETTE = python -m lynette
INPUT_PNE = geo_forwarding.pne
TOPOLOGY = topology.json
SERVICE = service.json
OUTPUT_DIR = ../../output/geo_example

# 颜色定义（Windows PowerShell 可能不支持，但保留用于 Linux/Mac）
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

.PHONY: all compile clean help test deploy topology flow use-cases arch validate

all: compile

help:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)GeoNetworking 车联网示例 Makefile$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "可用命令:"
	@echo "  $(YELLOW)make compile$(NC)    - 编译 PNE 代码为 P4 代码"
	@echo "  $(YELLOW)make clean$(NC)      - 清理生成的文件"
	@echo "  $(YELLOW)make test$(NC)       - 显示测试场景"
	@echo "  $(YELLOW)make deploy$(NC)     - 显示部署指南"
	@echo "  $(YELLOW)make topology$(NC)   - 显示网络拓扑"
	@echo "  $(YELLOW)make flow$(NC)       - 显示转发流程"
	@echo "  $(YELLOW)make use-cases$(NC)  - 显示应用场景"
	@echo "  $(YELLOW)make arch$(NC)       - 显示架构组件"
	@echo "  $(YELLOW)make validate$(NC)   - 验证配置文件"
	@echo "  $(YELLOW)make help$(NC)       - 显示此帮助信息"
	@echo ""
	@echo "配置:"
	@echo "  输入文件: $(INPUT_PNE)"
	@echo "  拓扑文件: $(TOPOLOGY)"
	@echo "  服务文件: $(SERVICE)"
	@echo "  输出目录: $(OUTPUT_DIR)"

compile: validate
	@echo "$(GREEN)开始编译 GeoNetworking PNE 代码...$(NC)"
	@if not exist "$(OUTPUT_DIR)" mkdir "$(OUTPUT_DIR)"
	$(LYNETTE) compile \
		--input $(INPUT_PNE) \
		--topology $(TOPOLOGY) \
		--service $(SERVICE) \
		--output $(OUTPUT_DIR)
	@echo "$(GREEN)编译完成！P4 代码已生成到 $(OUTPUT_DIR)$(NC)"
	@echo ""
	@echo "生成的文件:"
	@dir /B "$(OUTPUT_DIR)"

clean:
	@echo "$(YELLOW)清理生成的文件...$(NC)"
	@if exist "$(OUTPUT_DIR)" rmdir /S /Q "$(OUTPUT_DIR)"
	@echo "$(GREEN)清理完成！$(NC)"

test: use-cases

deploy:
	@echo "$(YELLOW)========================================$(NC)"
	@echo "$(YELLOW)GeoNetworking 部署指南$(NC)"
	@echo "$(YELLOW)========================================$(NC)"
	@echo ""
	@if not exist "$(OUTPUT_DIR)" (
		echo "$(RED)错误: 请先运行 'make compile' 生成 P4 代码$(NC)"
		exit /b 1
	)
	@echo "$(GREEN)部署步骤:$(NC)"
	@echo ""
	@echo "1. 启动 rsu-north (北侧RSU):"
	@echo "   simple_switch_grpc --device-id 1 -i 1@veth1 -i 2@veth2 -i 3@veth3 \"
	@echo "       $(OUTPUT_DIR)/rsu-north.p4.json"
	@echo ""
	@echo "2. 启动 rsu-south (南侧RSU):"
	@echo "   simple_switch_grpc --device-id 2 -i 1@veth4 -i 3@veth5 \"
	@echo "       $(OUTPUT_DIR)/rsu-south.p4.json"
	@echo ""
	@echo "3. 启动 rsu-east (东侧RSU):"
	@echo "   simple_switch_grpc --device-id 3 -i 1@veth6 -i 2@veth7 -i 3@veth8 \"
	@echo "       $(OUTPUT_DIR)/rsu-east.p4.json"
	@echo ""
	@echo "4. 启动 rsu-west (西侧RSU):"
	@echo "   simple_switch_grpc --device-id 4 -i 1@veth9 -i 3@veth10 \"
	@echo "       $(OUTPUT_DIR)/rsu-west.p4.json"
	@echo ""
	@echo "5. 启动 rsu-center (中心RSU):"
	@echo "   simple_switch_grpc --device-id 5 -i 1@veth11 -i 2@veth12 -i 3@veth13 -i 4@veth14 \"
	@echo "       $(OUTPUT_DIR)/rsu-center.p4.json"
	@echo ""
	@echo "$(YELLOW)注意: 需要根据实际环境调整网络接口$(NC)"

topology:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)GeoNetworking 网络拓扑$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "                    [rsu-north]"
	@echo "                   (北侧RSU)"
	@echo "                   39.9075N, 116.3972E"
	@echo "                        |"
	@echo "                   Vehicle-1"
	@echo "                        |"
	@echo "    [rsu-west] ---  [rsu-center]  --- [rsu-east]"
	@echo "   (西侧RSU)         (中心RSU)         (东侧RSU)"
	@echo "  39.9065N          39.9065N          39.9065N"
	@echo "  116.3952E         116.3972E         116.3992E"
	@echo "       |                |                 |"
	@echo "  Emergency-V           |            Vehicle-2"
	@echo "                        |"
	@echo "                   [rsu-south]"
	@echo "                   (南侧RSU)"
	@echo "                   39.9055N, 116.3972E"
	@echo "                        |"
	@echo "                   Vehicle-3"
	@echo ""
	@echo "$(BLUE)通信范围:$(NC)"
	@echo "  - 边缘RSU: 300米"
	@echo "  - 中心RSU: 500米"
	@echo "  - RSU间距: 约200米"
	@echo ""
	@echo "$(BLUE)地理区域:$(NC)"
	@echo "  - 路口核心区: 圆形，半径150米"
	@echo "  - 北向接近段: 矩形，50m x 200m"
	@echo "  - 事故区域: 圆形，半径80米（东北象限）"

flow:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)GeoNetworking 转发流程$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)GeoBroadcast (GBC) 转发:$(NC)"
	@echo ""
	@echo "1. 接收 GBC 消息"
	@echo "   ↓"
	@echo "2. 检查剩余跳数 (RHL > 0?)"
	@echo "   ↓"
	@echo "3. 序列号检查（防重复）"
	@echo "   ↓"
	@echo "4. 更新位置表（记录源节点）"
	@echo "   ↓"
	@echo "5. 地理区域检查"
	@echo "   ├─ 在区域内 → 广播到所有邻居"
	@echo "   └─ 不在区域内 ↓"
	@echo "6. 贪婪转发"
	@echo "   ├─ 查找位置表"
	@echo "   ├─ 计算到目标距离"
	@echo "   └─ 选择最近邻居"
	@echo "   ↓"
	@echo "7. 减少 RHL，更新头部"
	@echo "   ↓"
	@echo "8. 转发数据包"
	@echo ""
	@echo "$(YELLOW)Beacon 处理:$(NC)"
	@echo ""
	@echo "1. 接收 Beacon"
	@echo "   ↓"
	@echo "2. 提取位置信息"
	@echo "   ↓"
	@echo "3. 更新位置表"
	@echo "   ↓"
	@echo "4. 不转发（单跳广播）"
	@echo ""
	@echo "$(YELLOW)GeoUnicast (GUC) 转发:$(NC)"
	@echo ""
	@echo "1. 接收 GUC 消息"
	@echo "   ↓"
	@echo "2. 检查目标地址"
	@echo "   ├─ 是本节点 → 上传应用层"
	@echo "   └─ 不是本节点 ↓"
	@echo "3. 查找目标位置"
	@echo "   ↓"
	@echo "4. 贪婪转发到最近邻居"

use-cases:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)GeoNetworking 应用场景$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)场景 1: 紧急制动警告$(NC)"
	@echo "描述: 车辆1在路口北侧紧急制动，向周边车辆广播DENM"
	@echo "消息类型: DENM (GeoBroadcast)"
	@echo "目标区域: 圆形，半径200米"
	@echo "路径: Vehicle-1 → RSU-North → RSU-Center → RSU-East/South"
	@echo "      → Vehicle-2, Vehicle-3"
	@echo "延迟要求: < 50ms"
	@echo ""
	@echo "$(YELLOW)场景 2: 紧急车辆接近$(NC)"
	@echo "描述: 救护车从西向东接近路口，广播高优先级警告"
	@echo "消息类型: DENM (GeoBroadcast, 高优先级)"
	@echo "目标区域: 矩形，100m x 400m，沿行驶方向"
	@echo "路径: Emergency-V → RSU-West → RSU-Center → 所有方向"
	@echo "优先级: 最高"
	@echo ""
	@echo "$(YELLOW)场景 3: 协作感知$(NC)"
	@echo "描述: 所有车辆周期性广播位置和状态信息"
	@echo "消息类型: CAM (Cooperative Awareness Message)"
	@echo "频率: 10 Hz"
	@echo "GeoNetworking类型: TSB (拓扑范围广播)"
	@echo "用途: 邻居发现，位置表维护"
	@echo ""
	@echo "$(YELLOW)场景 4: 事故通知$(NC)"
	@echo "描述: 路口东北象限发生事故，向该区域广播警告"
	@echo "消息类型: DENM (GeoBroadcast)"
	@echo "目标区域: 圆形，半径80米（事故点）"
	@echo "参与RSU: RSU-Center, RSU-North, RSU-East"
	@echo "特点: 基于区域的选择性转发"
	@echo ""
	@echo "$(BLUE)消息优先级:$(NC)"
	@echo "  - 紧急消息: 最高（救护车、消防车）"
	@echo "  - 安全消息: 高（碰撞警告、紧急制动）"
	@echo "  - 普通消息: 正常（协作感知、路况信息）"

arch:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)GeoNetworking 架构组件$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)核心模块:$(NC)"
	@echo ""
	@echo "1. GeoParser - 数据包解析器"
	@echo "   - 解析 GeoNetworking 各种头部"
	@echo "   - 支持 Beacon、GBC、GUC 等类型"
	@echo "   - 提取地理位置信息"
	@echo ""
	@echo "2. LocationTable - 位置表"
	@echo "   - 维护邻居节点位置信息"
	@echo "   - 从 Beacon/CAM 更新"
	@echo "   - 容量: 256 条目"
	@echo ""
	@echo "3. GeoAreaCheck - 地理区域检查"
	@echo "   - 判断是否在目标区域内"
	@echo "   - 支持圆形、矩形、椭圆"
	@echo "   - 计算距离"
	@echo ""
	@echo "4. GreedyForwarding - 贪婪转发"
	@echo "   - 选择最接近目标的邻居"
	@echo "   - 实现地理位置路由核心算法"
	@echo "   - 处理转发失败"
	@echo ""
	@echo "5. SequenceNumberCheck - 序列号检查"
	@echo "   - 防止重复接收"
	@echo "   - 维护序列号缓存（512条目）"
	@echo "   - 环路检测"
	@echo ""
	@echo "6. GeoStatistics - 统计模块"
	@echo "   - 统计各类消息数量"
	@echo "   - 监控转发性能"
	@echo "   - 区域命中率"
	@echo ""
	@echo "$(YELLOW)协议栈:$(NC)"
	@echo ""
	@echo "  +------------------------+"
	@echo "  | Application Layer      |  CAM, DENM, SPAT"
	@echo "  +------------------------+"
	@echo "  | Transport Layer (BTP)  |  Port-based routing"
	@echo "  +------------------------+"
	@echo "  | Network Layer (GN)     |  Geographic routing"
	@echo "  | - Basic Header         |"
	@echo "  | - Common Header        |"
	@echo "  | - Extended Header      |"
	@echo "  +------------------------+"
	@echo "  | Link Layer             |  IEEE 802.11p / ITS-G5"
	@echo "  +------------------------+"
	@echo "  | Physical Layer         |  5.9 GHz DSRC"
	@echo "  +------------------------+"

validate:
	@echo "$(YELLOW)验证配置文件...$(NC)"
	@if not exist "$(INPUT_PNE)" (
		echo "$(RED)错误: 找不到 $(INPUT_PNE)$(NC)"
		exit /b 1
	)
	@if not exist "$(TOPOLOGY)" (
		echo "$(RED)错误: 找不到 $(TOPOLOGY)$(NC)"
		exit /b 1
	)
	@if not exist "$(SERVICE)" (
		echo "$(RED)错误: 找不到 $(SERVICE)$(NC)"
		exit /b 1
	)
	@echo "$(GREEN)配置文件验证通过！$(NC)"

stats:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)性能参数$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "协议参数:"
	@echo "  - Beacon 间隔: 1000 ms"
	@echo "  - CAM 频率: 10 Hz"
	@echo "  - 最大跳数: 10"
	@echo "  - 包生存时间: 60 秒"
	@echo ""
	@echo "表容量:"
	@echo "  - 位置表: 256 条目"
	@echo "  - 序列号缓存: 512 条目"
	@echo ""
	@echo "QoS 要求:"
	@echo "  - 紧急消息延迟: < 50 ms"
	@echo "  - 安全消息延迟: < 100 ms"
	@echo "  - 紧急消息成功率: > 99%%"
	@echo "  - 安全消息成功率: > 95%%"

